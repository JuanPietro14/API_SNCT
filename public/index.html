<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estação Meteorológica</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="script.js"></script>
</head>

<body>

    <!-- Cabeçalho -->
    <header class="header">
        <!--<img src="logo-ifnmg.png" id="logo-ifnmg">-->
        <h1>Estação Meteorológica</h1>
    </header>

    <!-- Seção de Dados Atuais -->
    <section id="dados-atualizados" class="dados-atualizados">
        <div class="cards">
            <div class="card">
                <h3>Temperatura</h3>
                <p><span id="temperatura">--</span></p>
            </div>
            <div class="card">
                <h3>Pressão</h3>
                <p><span id="umidade">--</span></p>
            </div>
            <div class="card">
                <h3>Umidade</h3>
                <p><span id="pressao">--</span></p>
            </div>
        </div>
    </section>

    <section class="visualizacao">
        <div class="graficos">
            <div class="vis-temperatura">
                <h1>Temperatura</h1>
                <canvas id="temperatura-graf"></canvas>
            </div>

            <div class="vis-pressao">
                <h1>Pressão</h1>
                <canvas id="pressao-graf"></canvas>
            </div>

            <div class="vis-umidade">
                <h1>Umidade</h1>
                <canvas id="umidade-graf"></canvas>
            </div>
        </div>
        <div class="pesquisa">
            <input type="date" id="dataFinal">
            <input type="time" id="horaFinal">
        </div>
    </section>

    <!-- Seção de Dados Históricos -->
    <section id="dados-historicos" class="dados-historicos">
        <h2>Dados Históricos</h2>

        <!-- Filtro de Pesquisa -->
        <div class="pesquisa">
            <label for="dataInicial">Início:</label>
            <input type="date" id="dataInicial">
            <input type="time" id="horaInicial">

            <label for="dataFinal">Término:</label>
            <input type="date" id="dataFinal">
            <input type="time" id="horaFinal">

            <button onclick="filtrarHistorico()">Buscar</button>
        </div>

        <!-- Tabela de Dados Históricos -->
        <table id="historicoTable">
            <thead>
                <tr>
                    <th>Data/Hora</th>
                    <th>Temperatura (°C)</th>
                    <th>Umidade (%)</th>
                    <th>Pressão (hPa)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Atualizado com as informações do banco de dados -->
            </tbody>
        </table>
    </section>

    <!-- Rodapé -->
    <footer class="footer">
        <p>Estação Meteorológica &copy; 2024</p>
    </footer>

    <!-- Script para filtrar os dados históricos -->
    <script>
        function filtrarHistorico() {
            var dataInicial = document.getElementById('dataInicial').value;
            var horaInicial = document.getElementById('horaInicial').value;
            var dataFinal = document.getElementById('dataFinal').value;
            var horaFinal = document.getElementById('horaFinal').value;

            var table = document.getElementById('historicoTable');
            var tr = table.getElementsByTagName('tr');

            for (var i = 1; i < tr.length; i++) {
                var td = tr[i].getElementsByTagName('td')[0]; // Coluna de data/hora
                if (td) {
                    var txtValue = td.textContent || td.innerText;
                    var dataHora = new Date(txtValue);

                    var filtroInicial = new Date(dataInicial + 'T' + horaInicial);
                    var filtroFinal = new Date(dataFinal + 'T' + horaFinal);

                    if (dataHora >= filtroInicial && dataHora <= filtroFinal) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }
    </script>

    <script>
        // Create the charts initially
        const ctx = document.getElementById('temperatura-graf');
        const ctx2 = document.getElementById('pressao-graf');
        const ctx3 = document.getElementById('umidade-graf');

        const myLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Initially empty
                datasets: [{
                    label: 'Temperatura',
                    data: [], // Initially empty
                    fill: true,
                    backgroundColor: 'rgb(252, 136, 136)',
                    borderColor: 'rgb(252, 37, 37)',
                    pointRadius: 1,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10 // Limit the number of ticks on the x-axis
                        }
                    },
                    y: {
                        min: 0,
                        max: 40
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        const myLineChart2 = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: [], // Initially empty
                datasets: [{
                    label: 'Pressão',
                    data: [], // Initially empty
                    fill: true,
                    backgroundColor: 'rgb(105, 206, 206)',
                    borderColor: 'rgb(75, 192, 192)',
                    pointRadius: 1,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10 // Limit the number of ticks on the x-axis
                        }
                    },
                    y: {
                        min: 900,
                        max: 1100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        const myLineChart3 = new Chart(ctx3, {
            type: 'line',
            data: {
                labels: [], // Initially empty
                datasets: [{
                    label: 'Umidade',
                    data: [], // Initially empty
                    fill: true,
                    backgroundColor: 'rgb(85, 174, 252)',
                    borderColor: 'rgb(37, 152, 252)',
                    pointRadius: 1,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 10 // Limit the number of ticks on the x-axis
                        }
                    },
                    y: {
                        min: 0,
                        max: 100
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        function updateCharts() {
            fetch('http://localhost:3000/api/historico')
                .then(response => response.json())
                .then(data => {
                    // Formatar hora
                    const hora = data.map(item => {
                        const date = new Date(item.data_hora);
                        // Convert to GMT-3
                        const gmtMinus3 = new Date(date.getTime() - (3 * 60 * 60 * 1000));
                        return gmtMinus3.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', hour12: false });
                    });

                    // Update the chart data
                    myLineChart.data.labels = hora.reverse();
                    myLineChart.data.datasets[0].data = data.map(item => item.temperatura).reverse();
                    myLineChart.update();

                    myLineChart2.data.labels = hora.reverse().reverse();
                    myLineChart2.data.datasets[0].data = data.map(item => item.pressao_atmosferica).reverse();
                    myLineChart2.update();

                    myLineChart3.data.labels = hora.reverse().reverse();
                    myLineChart3.data.datasets[0].data = data.map(item => item.umidade).reverse();
                    myLineChart3.update();
                })
                .catch(error => console.error(error));
        }

        // Call updateCharts every 2 seconds
        setInterval(updateCharts, 2000);
    </script>

</body>

</html>
